SELECT
  userID, dateJoined, lastLessonDate, 80precent, shortname AS trackName,serial_number AS lessonNo,branchName, branchType, active
FROM (
SELECT userid_connect,  trackID, lesson_id_connect , FROM_UNIXTIME(lastLesson, '%Y-%m-%d') AS lastLessonDate
FROM(
SELECT userid_connect, track_id_connect AS trackID, lesson_id_connect, MAX(timestamp) as lastLesson FROM lessons_followup GROUP BY userid_connect
    ) AS lastLesson
) AS convertedTime
LEFT JOIN (SELECT userid_connect AS userID, FROM_UNIXTIME(date_joined_lms, '%Y-%m-%d') AS dateJoined, branch_ID AS BranchID FROM users_new) AS usersSubset
ON   convertedTime.userid_connect = userID
LEFT JOIN lessons_mapping ON lessons_mapping.lesson_id_connect=convertedTime.lesson_id_connect
left JOIN
(
SELECT id AS branch_ID, short_name AS branchName, branchTypes AS branchType, active
FROM (
    SELECT id AS branchTypeID, branch_type AS branchTypes FROM branch_types) AS Branch_Types
RIGHT JOIN branch on branch.branch_type=Branch_Types.branchTypeID) AS Branches
on branch_ID=BranchID
LEFT JOIN tracks ON tracks.track_id_connect=convertedTime.trackID WHERE track_category NOT IN (0,8) AND track_type NOT IN (0,3) AND active IS NOT NULL AND UNIX_TIMESTAMP(lastLessonDate) BETWEEN UNIX_TIMESTAMP('2020-01-01') AND UNIX_TIMESTAMP('2020-12-01')